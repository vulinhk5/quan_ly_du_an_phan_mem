package ForgotPassword;

import Core.User;
import SceneManager.SceneManager;
import javafx.scene.control.TextField;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.MockedStatic;

import static org.mockito.Mockito.*;

import static Database.UserManager.*;
import static Utility.RandomGenerator.generateNewPassword;

public class ForgotPasswordControllerTest {

    private ForgotPasswordController controller;

    @BeforeEach
    void setup() {
        controller = new ForgotPasswordController();
        controller.userName = new TextField();
    }

    // ==========================================================
    // TC1 — Username không tồn tại
    // ==========================================================
    @Test
    void testUsernameNotFound() {
        controller.userName.setText("unknown");

        try (MockedStatic<Database.UserManager> mockUserMgr = mockStatic(Database.UserManager.class)) {

            mockUserMgr.when(() -> isUsernameTaken("unknown")).thenReturn(false);

            controller.onMouseClickedOnSendEmail();

            // Không gọi getUser
            mockUserMgr.verify(() -> getUser(anyString()), times(0));

            // Không update user
            mockUserMgr.verify(() -> updateUser(any()), times(0));
        }
    }

    // ==========================================================
    // TC2 — Lấy lại mật khẩu thành công
    // ==========================================================
    @Test
    void testResetPasswordSuccess() {

        controller.userName.setText("validUser");

        User mockUser = mock(User.class);

        try (
            MockedStatic<Database.UserManager> mockUserMgr = mockStatic(Database.UserManager.class);
            MockedStatic<Utility.RandomGenerator> mockRand = mockStatic(Utility.RandomGenerator.class);
            MockedStatic<SceneManager> mockScene = mockStatic(SceneManager.class);
            MockedStatic<ForgotPassword.NewPasswordEmail> mockEmail = mockStatic(ForgotPassword.NewPasswordEmail.class)
        ) {
            // 1. Username tồn tại
            mockUserMgr.when(() -> isUsernameTaken("validUser")).thenReturn(true);

            // 2. Trả về user
            mockUserMgr.when(() -> getUser("validUser")).thenReturn(mockUser);

            when(mockUser.getEmail()).thenReturn("test@example.com");
            when(mockUser.getFullName()).thenReturn("Nguyen Van A");

            // 3. Mật khẩu mới tạo random
            mockRand.when(Utility.RandomGenerator::generateNewPassword).thenReturn("NEW_PASS");

            // 4. SceneManager mock
            SceneManager fakeScene = mock(SceneManager.class);
            mockScene.when(SceneManager::getInstance).thenReturn(fakeScene);

            // 5. Thực thi hành động
            controller.onMouseClickedOnSendEmail();

            // ===================================================
            // VERIFY RESULT
            // ===================================================

            // Gọi setPasswordHash(newPassword)
            verify(mockUser, times(1)).setPasswordHash("NEW_PASS");

            // DB updateUser
            mockUserMgr.verify(() -> updateUser(mockUser), times(1));

            // Chuyển về Login
            verify(fakeScene, times(1)).switchTo(SceneManager.LOGIN);

            // Gửi email
            mockEmail.verify(() ->
                ForgotPassword.NewPasswordEmail.sendPasswordResetEmail(
                        "test@example.com",
                        "Nguyen Van A",
                        "NEW_PASS"
                ),
                times(1)
            );
        }
    }
}
